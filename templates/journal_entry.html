{% extends "layout.html" %}

{% block title %}Journal Entry{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h2 class="mb-0">
                        {% if view_only %}
                        Journal Entry: {{ entry.title }}
                        {% else %}
                        {% if entry %}Edit{% else %}New{% endif %} Journal Entry
                        {% endif %}
                    </h2>
                </div>
                <div class="card-body">
                    {% if view_only and entry %}
                    <!-- View only mode -->
                    <div class="mb-3">
                        <h5 class="form-label">Date</h5>
                        <p>{{ entry.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    </div>
                    <div class="mb-3">
                        <h5 class="form-label">Anxiety Level</h5>
                        <p>
                            {% if entry.anxiety_level <= 3 %}
                            <span class="badge bg-success">{{ entry.anxiety_level }}</span>
                            {% elif entry.anxiety_level <= 6 %}
                            <span class="badge bg-warning text-dark">{{ entry.anxiety_level }}</span>
                            {% else %}
                            <span class="badge bg-danger">{{ entry.anxiety_level }}</span>
                            {% endif %}
                            /10
                        </p>
                    </div>
                    <div class="mb-4">
                        <h5 class="form-label">Journal Content</h5>
                        <div class="p-3 bg-light rounded text-dark">
                            {{ entry.content | nl2br | safe }}
                        </div>
                    </div>
                    <div class="text-center">
                        <a href="{{ url_for('journal_blueprint.update_journal_entry', entry_id=entry.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Edit Entry
                        </a>
                        <a href="{{ url_for('journal_blueprint.journal_list') }}" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-arrow-left"></i> Back to Journal
                        </a>
                    </div>
                    {% else %}
                    <!-- Edit/New mode -->
                    <form id="journal-form" method="POST">
                        {{ form.hidden_tag() }}
                        <div class="form-group mb-3">
                            {{ form.title.label(class="form-label") }}
                            {% if form.title.errors %}
                                {{ form.title(class="form-control is-invalid") }}
                                <div class="invalid-feedback">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ form.title(class="form-control") }}
                            {% endif %}
                        </div>
                        <div class="form-group mb-3">
                            {{ form.content.label(class="form-label") }}
                            <div class="voice-input-container">
                                {% if form.content.errors %}
                                    {{ form.content(class="form-control is-invalid", rows=8, id="journal-content") }}
                                    <div class="invalid-feedback">
                                        {% for error in form.content.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    {{ form.content(class="form-control", rows=8, id="journal-content") }}
                                {% endif %}
                                
                                <div class="voice-input-controls">
                                    <button type="button" id="voice-input-button" class="btn btn-outline-primary" 
                                            title="Start Voice Input (Click again to stop)">
                                        <i class="bi bi-mic"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="voice-input-status" class="voice-status mt-2 d-none">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Listening...</span>
                                    </div>
                                    <span id="voice-status-text">Listening... Click mic button again to stop</span>
                                </div>
                            </div>
                            
                            <div class="form-text mt-2">
                                Express yourself freely. This journal is private to you, and the AI 
                                analysis is only used to help you identify patterns and suggest coping strategies.
                                <span class="text-primary ms-2"><i class="bi bi-info-circle"></i> Voice input is available!</span>
                            </div>
                        </div>
                        <div class="form-group mb-4">
                            {{ form.anxiety_level.label(class="form-label") }}
                            <div class="range-container">
                                <input type="range" class="form-range" id="anxiety-slider" min="1" max="10" value="{{ form.anxiety_level.data or 5 }}" oninput="updateAnxietyLabel(this.value)">
                                <div class="range-labels d-flex justify-content-between">
                                    <span>Low</span>
                                    <span>Medium</span>
                                    <span>High</span>
                                </div>
                            </div>
                            <div class="text-center mb-2">
                                <span id="anxiety-value" class="badge bg-primary">{{ form.anxiety_level.data or 5 }}</span>/10
                            </div>
                            {{ form.anxiety_level(class="d-none", id="anxiety-input") }}
                        </div>
                        <div class="text-center">
                            <button type="submit" id="journal-submit-button" class="btn btn-primary">
                                <i class="bi bi-journal-check"></i> Save Entry
                            </button>
                            <a href="{{ url_for('journal_blueprint.journal_list') }}" class="btn btn-outline-secondary ms-2">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if entry and entry.is_analyzed %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow" id="analysis-card">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #007bff; color: white;">
                    <h3 class="mb-0">Mira's Insights</h3>
                    <button type="button" class="btn btn-sm btn-outline-light" id="refresh-analysis" data-journal-id="{{ entry.id }}">
                        <i class="bi bi-arrow-repeat"></i> Refresh Analysis
                    </button>
                </div>
                <div class="card-body" style="background-color: white !important;">
                    <div id="analysis-content" style="background-color: white !important; color: #212529 !important; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; line-height: 1.6;">
                        <div class="coach-insights">
                            {{ coach_response | safe }}
                        </div>
                    </div>
                    
                    <style>
                        .coach-insights p {
                            margin-bottom: 1rem;
                            font-size: 1rem;
                        }
                        .coach-insights h5 {
                            margin-top: 1.5rem;
                            margin-bottom: 1rem;
                            color: #007bff;
                            font-weight: 600;
                            border-bottom: 1px solid #e9ecef;
                            padding-bottom: 0.5rem;
                        }
                        /* Voice input styling */
                        .voice-input-container {
                            position: relative;
                        }
                        .voice-input-controls {
                            position: absolute;
                            bottom: 10px;
                            right: 10px;
                            z-index: 10;
                        }
                        #voice-input-button {
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            padding: 0;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                        }
                        #voice-input-button.active {
                            background-color: #dc3545;
                            border-color: #dc3545;
                            color: white;
                            animation: pulse 1.5s infinite;
                        }
                        .voice-status {
                            padding: 8px 12px;
                            border-radius: 4px;
                            background-color: #f8f9fa;
                            border: 1px solid #dee2e6;
                        }
                        @keyframes pulse {
                            0% {
                                transform: scale(1);
                                opacity: 1;
                            }
                            50% {
                                transform: scale(1.05);
                                opacity: 0.8;
                            }
                            100% {
                                transform: scale(1);
                                opacity: 1;
                            }
                        }
                    </style>
                    
                    <!-- Placeholder for AI coaching button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-success" id="ask-coach" data-journal-id="{{ entry.id }}">
                            <i class="bi bi-chat-dots"></i> 
                            Ask Mira for Personalized Guidance
                        </button>
                    </div>
                    
                    <!-- Response area (hidden initially) -->
                    <div id="coach-response" class="mt-4 bg-light p-3 rounded" style="display: none;">
                        <h5><i class="bi bi-chat-heart-fill text-success"></i> Mira's Personal Guidance:</h5>
                        <div id="coach-message" class="mt-2 bg-white p-3 rounded text-dark">
                            <!-- Will be filled by AJAX response -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if entry and not entry.is_analyzed %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow" id="analyze-card">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Ready for Analysis</h3>
                </div>
                <div class="card-body text-center">
                    <p>Your entry hasn't been analyzed yet. Would you like Mira to help identify thought patterns and suggest coping strategies?</p>
                    <button class="btn btn-primary" id="analyze-entry" data-journal-id="{{ entry.id }}">
                        <i class="bi bi-lightbulb"></i> 
                        Analyze My Entry
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Additional information -->
<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header" style="background-color: #6c757d; color: white;">
                    <h3 class="mb-0">About Journal Analysis</h3>
                </div>
                <div class="card-body">
                    <p>The AI analysis helps identify thought patterns from cognitive behavioral therapy (CBT) and suggests personalized coping strategies. Your data is private and secure.</p>
                    
                    <h5 class="mt-3">Common Thought Patterns:</h5>
                    <ul>
                        <li><strong>Catastrophizing:</strong> Assuming the worst will happen</li>
                        <li><strong>Black-and-White Thinking:</strong> Viewing things as all good or all bad</li>
                        <li><strong>Overgeneralization:</strong> Applying one negative experience to all situations</li>
                        <li><strong>Mind Reading:</strong> Assuming you know what others are thinking</li>
                        <li><strong>Emotional Reasoning:</strong> Believing feelings reflect reality</li>
                    </ul>
                    
                    <p class="text-info mt-3">
                        <i class="bi bi-info-circle"></i> 
                        Analysis takes about 5-10 seconds to complete.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Voice input functionality
    function setupVoiceInput() {
        const voiceButton = document.getElementById('voice-input-button');
        const journalContent = document.getElementById('journal-content');
        const statusDiv = document.getElementById('voice-input-status');
        const statusText = document.getElementById('voice-status-text');
        
        // Check if browser supports speech recognition
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            // Hide the voice input button if speech recognition isn't supported
            if (voiceButton) {
                voiceButton.style.display = 'none';
            }
            console.log('Speech recognition not supported in this browser');
            return;
        }
        
        // Initialize speech recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        
        // Configure recognition
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US'; // Default to English
        
        let isListening = false;
        let finalTranscript = '';
        
        // Add event listeners for the voice button
        if (voiceButton && journalContent) {
            voiceButton.addEventListener('click', toggleSpeechRecognition);
        }
        
        // Function to toggle speech recognition on/off
        function toggleSpeechRecognition() {
            if (isListening) {
                // Stop listening
                recognition.stop();
                isListening = false;
                voiceButton.classList.remove('active');
                statusDiv.classList.add('d-none');
                
                // Update button
                voiceButton.innerHTML = '<i class="bi bi-mic"></i>';
                voiceButton.title = 'Start Voice Input (Click again to stop)';
            } else {
                // If there's existing content, preserve it and add a space
                if (journalContent.value && !journalContent.value.endsWith(' ')) {
                    finalTranscript = journalContent.value + ' ';
                } else {
                    finalTranscript = journalContent.value;
                }
                
                // Start listening
                try {
                    recognition.start();
                    isListening = true;
                    voiceButton.classList.add('active');
                    statusDiv.classList.remove('d-none');
                    
                    // Update button
                    voiceButton.innerHTML = '<i class="bi bi-mic-fill"></i>';
                    voiceButton.title = 'Stop Voice Input';
                    
                    console.log('Speech recognition started');
                } catch (err) {
                    console.error('Speech recognition error:', err);
                    alert('Could not start speech recognition. Please try again.');
                }
            }
        }
        
        // Handle results
        recognition.onresult = function(event) {
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            
            // Update textarea with the transcript
            journalContent.value = finalTranscript + interimTranscript;
            
            // Auto-scroll to the bottom of the textarea
            journalContent.scrollTop = journalContent.scrollHeight;
            
            // Update word count in status
            const wordCount = journalContent.value.trim().split(/\s+/).filter(Boolean).length;
            statusText.textContent = `Listening... ${wordCount} words recorded. Click mic button again to stop.`;
        };
        
        // Handle errors
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            
            // If error is not 'aborted' (which happens on normal stop)
            if (event.error !== 'aborted') {
                alert(`Speech recognition error: ${event.error}. Please try again.`);
                
                // Reset state
                isListening = false;
                voiceButton.classList.remove('active');
                statusDiv.classList.add('d-none');
                voiceButton.innerHTML = '<i class="bi bi-mic"></i>';
            }
        };
        
        // Handle end of recognition
        recognition.onend = function() {
            if (isListening) {
                // If it ended unexpectedly while still in listening mode, restart
                try {
                    recognition.start();
                    console.log('Restarted speech recognition after unexpected end');
                } catch (err) {
                    // If we can't restart, reset the UI
                    console.error('Could not restart speech recognition:', err);
                    isListening = false;
                    voiceButton.classList.remove('active');
                    statusDiv.classList.add('d-none');
                    voiceButton.innerHTML = '<i class="bi bi-mic"></i>';
                }
            }
        };
    }
    
    // Function to update the anxiety level display
    function updateAnxietyLabel(value) {
        const anxietyValue = document.getElementById('anxiety-value');
        const anxietyInput = document.getElementById('anxiety-input');
        
        // Only proceed if the elements exist (they won't in view-only mode)
        if (anxietyValue && anxietyInput) {
            anxietyValue.textContent = value;
            anxietyInput.value = value;
            
            // Change badge color based on anxiety level
            if (value <= 3) {
                anxietyValue.className = 'badge bg-success';
            } else if (value <= 6) {
                anxietyValue.className = 'badge bg-warning text-dark';
            } else {
                anxietyValue.className = 'badge bg-danger';
            }
        }
    }
    
    // Set up event listeners when document is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Set the initial anxiety level (only if we're in edit mode)
        const anxietySlider = document.getElementById('anxiety-slider');
        if (anxietySlider) {
            const sliderValue = anxietySlider.value;
            updateAnxietyLabel(sliderValue);
        }
        
        // Set up the form handling with spinner
        const journalForm = document.getElementById('journal-form');
        const submitButton = document.getElementById('journal-submit-button');
        
        if (journalForm && submitButton) {
            journalForm.addEventListener('submit', function(event) {
                // Check if form is valid before showing spinner
                if (journalForm.checkValidity()) {
                    // Replace button content with spinner and text
                    submitButton.innerHTML = '<div class="d-flex align-items-center justify-content-center"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...</div>';
                    submitButton.disabled = true;
                    
                    // Debug log
                    console.log('Showing spinner on journal submit');
                }
            });
        }
        
        // Setup voice input functionality
        setupVoiceInput();
        
        // Set up the analyze button with spinner
        const analyzeButton = document.getElementById('analyze-entry');
        if (analyzeButton) {
            analyzeButton.addEventListener('click', function() {
                const journalId = this.getAttribute('data-journal-id');
                
                // Show spinner in button
                this.innerHTML = '<div class="d-flex align-items-center justify-content-center"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Analyzing...</div>';
                this.disabled = true;
                
                // Call API to analyze entry
                fetch(`/api/analyze-entry/${journalId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page to show new analysis
                            window.location.reload();
                        } else {
                            alert('Error analyzing entry: ' + data.error);
                            // Reset button
                            this.innerHTML = '<i class="bi bi-lightbulb"></i> Analyze My Entry';
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred during analysis. Please try again.');
                        // Reset button
                        this.innerHTML = '<i class="bi bi-lightbulb"></i> Analyze My Entry';
                        this.disabled = false;
                    });
            });
        }
        
        // Set up the ask coach button with spinner
        const coachButton = document.getElementById('ask-coach');
        if (coachButton) {
            coachButton.addEventListener('click', function() {
                const journalId = this.getAttribute('data-journal-id');
                
                // Show spinner in button
                this.innerHTML = '<div class="d-flex align-items-center justify-content-center"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Asking Mira...</div>';
                this.disabled = true;
                
                // Call API to get coaching
                fetch(`/api/journal-coach/${journalId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show coach response area and populate it
                            document.getElementById('coach-response').style.display = 'block';
                            const coachMessage = document.getElementById('coach-message');
                            
                            // Apply the same CSS as the main response
                            let responseText = data.response;
                            // Add signature if it doesn't already exist
                            if (!responseText.includes("Warmly,") && !responseText.includes("Coach Mira")) {
                                responseText += "\n\nWarmly,\nCoach Mira";
                            }
                            coachMessage.innerHTML = `<div class="coach-insights">${responseText}</div>`;
                            coachMessage.style.color = 'black';
                            coachMessage.style.backgroundColor = 'white';
                            
                            // Reset button
                            this.innerHTML = '<i class="bi bi-chat-dots"></i> Ask Mira Again';
                            this.disabled = false;
                            
                            // Scroll to response
                            document.getElementById('coach-response').scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                        } else {
                            alert('Error getting coaching: ' + data.error);
                            // Reset button
                            this.innerHTML = '<i class="bi bi-chat-dots"></i> Ask Mira for Personalized Guidance';
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while asking Mira. Please try again.');
                        // Reset button
                        this.innerHTML = '<i class="bi bi-chat-dots"></i> Ask Mira for Personalized Guidance';
                        this.disabled = false;
                    });
            });
        }
        
        // Set up the refresh analysis button
        const refreshButton = document.getElementById('refresh-analysis');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                const journalId = this.getAttribute('data-journal-id');
                
                // Show spinner in button
                this.innerHTML = '<div class="d-flex align-items-center justify-content-center"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Refreshing...</div>';
                this.disabled = true;
                
                // Call API to analyze entry
                fetch(`/api/analyze-entry/${journalId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page to show new analysis
                            window.location.reload();
                        } else {
                            alert('Error refreshing analysis: ' + data.error);
                            // Reset button
                            this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Refresh Analysis';
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred during refresh. Please try again.');
                        // Reset button
                        this.innerHTML = '<i class="bi bi-arrow-repeat"></i> Refresh Analysis';
                        this.disabled = false;
                    });
            });
        }
    });
</script>
{% endblock %}
